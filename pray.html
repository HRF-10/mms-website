<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="utf-8">
    <title>Jadwal Sholat - Masjid Dalem Kalitan Solo</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;600;700&family=Pacifico&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries CSS -->
    <link href="lib/animate/animate.min.css" rel="stylesheet">
    <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Main Styles -->
    <link href="css/style.css" rel="stylesheet">

    <style>
        .prayer-box {
            background: rgba(255,255,255,0.45);
            border: 1px solid rgba(255,255,255,0.25);
            backdrop-filter: blur(10px);
            padding: 35px;
            border-radius: 18px;
        }

        .countdown-box {
            margin-top: 25px;
            background: rgba(0,0,0,0.06);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .countdown-time {
            font-size: 42px;
            font-weight: bold;
            color: #0d6efd;
        }

        .khutbah-section {
            background: rgba(255,255,255,0.7);
            border-radius: 18px;
            padding: 40px;
        }

        table.prayer-table {
            width: 100%;
            margin-top: 20px;
        }

        table.prayer-table td {
            padding: 12px 0;
            font-size: 20px;
            border-bottom: 1px solid #ddd;
        }

        .week-table thead th {
            background: #f8f9fa;
        }

        .next-prayer {
            border-left: 5px solid #0d6efd;
            padding-left: 12px;
            background: rgba(13,110,253,0.04);
            border-radius: 8px;
        }
    </style>
</head>

<body>
<!-- NAVBAR -->
<div class="container-fluid fixed-top">
    <div class="container">
        <nav class="navbar navbar-light navbar-expand-lg py-3">
            <a href="index.html" class="navbar-brand">
                <h1 class="mb-0">Masjid <span class="text-primary">Dalem Kalitan</span></h1>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                <span class="fa fa-bars text-primary"></span>
            </button>
            <div class="collapse navbar-collapse bg-white" id="navbarCollapse">
                <div class="navbar-nav ms-lg-auto mx-xl-auto">
                    <a href="index.html" class="nav-item nav-link">Beranda</a>
                    <a href="kegiatan.html" class="nav-item nav-link">Kegiatan</a>
                    <a href="keuangan.html" class="nav-item nav-link">Keuangan</a>
                    <a href="pray.html" class="nav-item nav-link active">Jadwal Sholat</a>
                    <a href="library.html" class="nav-item nav-link">Qur'an & Pustaka</a>
                </div>
                <a href="keuangan.html" class="btn btn-primary py-2 px-4 d-none d-xl-inline-block">Infaq</a>
            </div>
        </nav>
    </div>
</div>

<!-- HERO -->
<div class="container-fluid hero-header">
    <div class="container">
        <div class="row">
            <div class="col-lg-7">
                <div class="hero-header-inner animated zoomIn">
                    <h1 class="display-1 text-dark">Jadwal Sholat</h1>
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a href="index.html">Beranda</a></li>
                        <li class="breadcrumb-item text-dark" aria-current="page">Jadwal Sholat</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CONTENT JADWAL -->
<div class="container py-5">

    <h1 class="display-3 mb-5 wow fadeIn" data-wow-delay="0.1s">
        Jadwal Sholat <span class="text-primary">Minggu Ini</span>
    </h1>

    <!-- Today's summary + countdown -->
    <div class="row g-4">
        <div class="col-lg-7">
            <div class="prayer-box shadow wow fadeIn" data-wow-delay="0.2s">
                <h4 class="mb-3"><i class="fa fa-calendar-alt text-primary"></i> <span id="todayDate"></span></h4>

                <table class="prayer-table">
                    <tr><td><strong>Subuh</strong></td><td id="subuh">--:--</td><td>Imam: Ust. Hasan</td></tr>
                    <tr><td><strong>Dzuhur</strong></td><td id="dzuhur">--:--</td><td>Imam: Ust. Basim</td></tr>
                    <tr><td><strong>Ashar</strong></td><td id="ashar">--:--</td><td>Imam: Ust. Rakhan</td></tr>
                    <tr><td><strong>Maghrib</strong></td><td id="maghrib">--:--</td><td>Imam: Ust. Zaki</td></tr>
                    <tr><td><strong>Isya</strong></td><td id="isya">--:--</td><td>Imam: Ust. Malik</td></tr>
                </table>

                <!-- COUNTDOWN -->
                <div class="countdown-box shadow mt-4">
                    <h4 id="countdownTitle" class="mb-2">Hitung Mundur</h4>
                    <div id="countdownTime" class="countdown-time">00:00:00</div>
                    <p id="countdownLabel" class="text-muted mt-2"></p>
                </div>

            </div>
        </div>

        <!-- Weekly table -->
        <div class="col-lg-5">
            <div class="p-4 shadow-sm rounded week-schedule">
                <h5 class="mb-3">Jadwal 7 Hari (Surakarta)</h5>
                <table class="table table-sm week-table">
                    <thead>
                        <tr>
                            <th>Tanggal</th>
                            <th>Subuh</th>
                            <th>Dzuhur</th>
                            <th>Asr</th>
                            <th>Maghrib</th>
                            <th>Isya</th>
                        </tr>
                    </thead>
                    <tbody id="weekBody">
                        <!-- rows generated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- KHUTBAH -->
<div class="container pb-5" id="khutbahSection">
    <div class="khutbah-section shadow wow fadeIn" data-wow-delay="0.3s">
        <h2 class="mb-3">Khutbah Jumat Minggu Ini</h2>
        <h4 class="text-primary">Ust. Abdul Karim</h4>
        <p>Tema: Menghidupkan Hati dengan Dzikir</p>
        <p><i class="fa fa-calendar"></i> Jumat — 11:40</p>
    </div>
</div>

<!-- FOOTER -->
<div class="container-fluid footer pt-5 wow fadeIn" data-wow-delay="0.1s">
    <div class="container py-5 text-center text-secondary">
        &copy; Masjid Dalem Kalitan Solo — Smart Mosque Project
    </div>
</div>

<!-- Scripts: order penting! -->
<!-- 1) jQuery (owl & plugins depend on jQuery) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

<!-- 2) Owl Carousel JS (kamu pakai CSS-nya; JS harus ada) -->
<script src="lib/owlcarousel/owl.carousel.min.js"></script>

<!-- 3) Bootstrap bundle (Bootstrap 5 tidak membutuhkan jQuery, tapi urutan ini aman) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- 4) wow.js (dipakai untuk animasi di halaman) -->
<script src="lib/wow/wow.min.js"></script>

<!-- 5) Adhan.js (harus dimuat sebelum kode yang memakai `adhan`) 
     -> menggunakan unpkg untuk menghindari masalah MIME pada jsdelivr yang kamu alami -->
<script src="https://unpkg.com/adhan@4.1.0/dist/adhan.min.js"></script>

<!-- 6) main.js (kode situs kamu yang memanggil owlCarousel, dll) -->
<script src="js/main.js"></script>

<!-- 7) Kode inline (menggunakan `adhan`) — pastikan ini berada setelah adhan.js -->
<script>
/* ----- KODE KAMU (tetap) ----- */
/* Saya tidak mengubah logika utama — hanya memastikan skrip ini dimuat setelah Adhan dan deps. */
/* 1) Location for Surakarta (Solo) */
const LAT = -7.566;
const LON = 110.824;

/* 2) Utility: current time in Jakarta (WIB, UTC+7) */
function nowJakarta() {
    const now = new Date();
    const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
    const jakartaTime = new Date(utc + (7 * 3600000));
    return jakartaTime;
}

/* 3) Format helper (shows HH:MM) with leading zeros */
function fmtTime(dateObj) {
    return dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Jakarta' });
}

/* 4) Compute prayer times for a given date (year,month,day) using Adhan.js */
function computeTimesForDate(year, month, day) {
    const date = new Date(Date.UTC(year, month - 1, day));
    const coordinates = new adhan.Coordinates(LAT, LON);
    const params = adhan.CalculationMethod.MuslimWorldLeague();
    params.madhab = adhan.Madhab.Shafi;
    const times = new adhan.PrayerTimes(coordinates, date, params);

    return {
        fajr: times.fajr,
        sunrise: times.sunrise,
        dhuhr: times.dhuhr,
        asr: times.asr,
        maghrib: times.maghrib,
        isha: times.isha
    };
}

/* 5) Build 7-day schedule starting from today (Jakarta date) */
function buildWeekSchedule() {
    const base = nowJakarta();
    const year = base.getFullYear();
    const month = base.getMonth() + 1;
    const day = base.getDate();

    const weekBody = document.getElementById("weekBody");
    weekBody.innerHTML = "";

    for (let i = 0; i < 7; i++) {
        const d = new Date(Date.UTC(year, month - 1, day + i));
        const y = d.getUTCFullYear();
        const m = d.getUTCMonth() + 1;
        const dd = d.getUTCDate();

        const t = computeTimesForDate(y, m, dd);

        const row = document.createElement("tr");
        const dateCell = document.createElement("td");
        dateCell.innerText = new Date(Date.UTC(y, m - 1, dd)).toLocaleDateString('id-ID', { weekday: 'short', day: 'numeric', month: 'short' , timeZone: 'Asia/Jakarta'});
        row.appendChild(dateCell);

        const cells = ['fajr','dhuhr','asr','maghrib','isha'].map(key => {
            const td = document.createElement("td");
            td.innerText = fmtTime(t[key]);
            return td;
        });

        cells.forEach(c => row.appendChild(c));
        weekBody.appendChild(row);
    }
}

/* 6) Fill today's times in main table */
function fillTodayTimes() {
    const now = nowJakarta();
    const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate();
    const times = computeTimesForDate(y, m, d);

    document.getElementById("subuh").innerText = fmtTime(times.fajr);
    document.getElementById("dzuhur").innerText = fmtTime(times.dhuhr);
    document.getElementById("ashar").innerText = fmtTime(times.asr);
    document.getElementById("maghrib").innerText = fmtTime(times.maghrib);
    document.getElementById("isya").innerText = fmtTime(times.isha);
}

/* 7) Find next upcoming prayer (returns object with name and Date target in Jakarta time). */
function findNextPrayer() {
    const now = nowJakarta();
    for (let dayOffset = 0; dayOffset < 8; dayOffset++) {
        const candidateDate = new Date(now.getTime() + dayOffset * 24 * 3600 * 1000);
        const y = candidateDate.getFullYear(), m = candidateDate.getMonth() + 1, d = candidateDate.getDate();
        const times = computeTimesForDate(y, m, d);

        const order = [
            { key: 'fajr', name: 'Subuh', date: times.fajr },
            { key: 'dhuhr', name: 'Dzuhur', date: times.dhuhr },
            { key: 'asr', name: 'Ashar', date: times.asr },
            { key: 'maghrib', name: 'Maghrib', date: times.maghrib },
            { key: 'isha', name: 'Isya', date: times.isha }
        ];

        for (let p of order) {
            const timeStr = p.date.toLocaleTimeString('en-GB', {hour12:false, timeZone:'Asia/Jakarta'});
            const [hh, mm, ss] = timeStr.split(':').map(Number);
            const dateStringISO = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00 GMT+0700`;
            const targetTime = new Date(dateStringISO);
            const nowEpoch = now.getTime();
            if (targetTime.getTime() - nowEpoch > 0) {
                return { name: p.name, time: targetTime, raw: p.date, dayOffset };
            }
        }
    }
    const tomorrow = new Date(now.getTime() + 24*3600*1000);
    const t = computeTimesForDate(tomorrow.getFullYear(), tomorrow.getMonth()+1, tomorrow.getDate());
    const dateStringISO = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth()+1).padStart(2,'0')}-${String(tomorrow.getDate()).padStart(2,'0')} ${String(t.fajr.getHours()).padStart(2,'0')}:${String(t.fajr.getMinutes()).padStart(2,'0')}:00 GMT+0700`;
    return { name: 'Subuh', time: new Date(dateStringISO), raw: t.fajr, dayOffset: 1 };
}

/* 8) Update countdown display every second */
function startCountdownLoop() {
    const countdownTimeEl = document.getElementById("countdownTime");
    const countdownTitleEl = document.getElementById("countdownTitle");
    const countdownLabelEl = document.getElementById("countdownLabel");

    let currentTarget = null;
    function tick() {
        const now = nowJakarta();
        if (!currentTarget || (currentTarget.time.getTime() - now.getTime() <= 0)) {
            const next = findNextPrayer();
            currentTarget = { time: next.time, name: next.name };

            if (now.getDay() === 5) {
                const y = now.getFullYear(), m = now.getMonth()+1, d = now.getDate();
                const t = computeTimesForDate(y,m,d);
                const timeStr = t.dhuhr.toLocaleTimeString('en-GB', {hour12:false, timeZone:'Asia/Jakarta'});
                const [hh, mm] = timeStr.split(':').map(Number);
                const jumatTimeObj = new Date(`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')} ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00 GMT+0700`);
                if (jumatTimeObj.getTime() - now.getTime() > 0) {
                    currentTarget.time = jumatTimeObj;
                    currentTarget.name = 'Sholat Jumat';
                }
            }

            countdownTitleEl.innerText = `Hitung Mundur ke ${currentTarget.name}`;
            countdownLabelEl.innerText = `Waktu target: ${currentTarget.time.toLocaleString('id-ID', { hour: '2-digit', minute: '2-digit', day: 'numeric', month: 'short', timeZone: 'Asia/Jakarta', hour12:false })} WIB`;
        }

        const diff = currentTarget.time.getTime() - now.getTime();
        const inProgressWindow = 5 * 60 * 1000;
        if (diff <= 0 && Math.abs(diff) <= inProgressWindow) {
            countdownTimeEl.innerText = "Sedang Berlangsung";
            return;
        }

        if (diff <= -inProgressWindow) {
            currentTarget = null;
            countdownTimeEl.innerText = "Memperbarui...";
            return;
        }

        const h = Math.floor(diff / (1000*60*60));
        const m = Math.floor((diff % (1000*60*60)) / (1000*60));
        const s = Math.floor((diff % (1000*60)) / 1000);
        countdownTimeEl.innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    tick();
    setInterval(tick, 1000);
}

/* 9) Initialize page */
function init() {
    const now = nowJakarta();
    document.getElementById("todayDate").innerText =
        now.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Asia/Jakarta' });

    buildWeekSchedule();
    fillTodayTimes();
    startCountdownLoop();

    document.getElementById('khutbahSection').style.display = 'block';
}

init();

setInterval(() => {
    const now = nowJakarta();
    if (now.getHours() === 0 && now.getMinutes() < 6) {
        buildWeekSchedule();
        fillTodayTimes();
    }
}, 60*1000);
</script>
</body>
</html>